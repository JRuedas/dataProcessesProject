---
title: "Data Processes Project"
author: Alejandro Basco Plaza, Miriam Zaragoza Pastor, Jonatan Ruedas Mora, Raúl Cruz
  Benita and Laura Sánchez de Rojas Huerta
date: "20/12/2019"
output: pdf_document
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

## Introduction and related work

## Exploratory data analysis

### Dataset description

Before exposing the results of the exploratory data analysis carried the data, important information and background about the dataset is introduced below:

The dataset used for this work was obtained from [Kaggle's website](https://www.kaggle.com/ "Kaggle's website"). In this page, we can find a lot of information and datasets about the air quality in Madrid.

The data in this data set has been collected from the original files provided by [Madrid Open Data.](https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=9e42c176313eb410VgnVCM1000000b205a0aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default) Decide soluciones organization processed them and uploaded to the [Kaggle's website](https://www.kaggle.com/decide-soluciones/air-quality-madrid).

Originally, Madrid Open Data get the data from 24 automatic stations around Madrid. Those stations, which are set around all the districts of the city, record information about pollution in the area. The data was generated from those stations whose pollution sensors measure air quality in Madrid city.

Regarding the observations, all csv files include twelve month data, except the last one that only has data until  May. According to this, we have the followings rows:

| CSV | Observations |
| --- | ------------ |
| Stations.csv | 24 rows |
| Madrid2001.csv | 217872 rows |
| Madrid2002.csv | 217296 rows |
| Madrid2003.csv | 243984 rows |
| Madrid2004.csv | 245496 rows |
| Madrid2005.csv | 237000 rows |
| Madrid2006.csv | 230568 rows |
| Madrid2007.csv | 225120 rows |
| Madrid2008.csv | 226392 rows |
| Madrid2009.csv | 215688 rows |
| Madrid2010.csv | 209448 rows |
| Madrid2011.csv | 209928 rows |
| Madrid2012.csv | 210720 rows |
| Madrid2013.csv | 209880 rows |
| Madrid2014.csv | 210024 rows |
| Madrid2015.csv | 210096 rows |
| Madrid2016.csv | 209496 rows |
| Madrid2017.csv | 210120 rows |
| Madrid2018.csv | 69096 rows |

We can also differentiate two domains whose columns represent different data:

On the one hand, we have Stations.csv with six columns, which contains information about the stations previously mentioned, in which the data about the pollution levels of the air is collected. On the other hand, we have Madrid20xx.csv, which contain the data about Madrid's air pollution itself. Some of these csv files have 14 columns, others 16 and others 17. We have the following columns in the csv files:

| CSV | Features |
| --- | -------- |
| Stations.csv | 6 columns |
| Madrid2001.csv | 16 columns |
| Madrid2002.csv | 16 columns |
| Madrid2003.csv | 16 columns |
| Madrid2004.csv | 17 columns |
| Madrid2005.csv | 17 columns |
| Madrid2006.csv | 17 columns |
| Madrid2007.csv | 17 columns |
| Madrid2008.csv | 17 columns |
| Madrid2009.csv | 17 columns |
| Madrid2010.csv | 17 columns |
| Madrid2011.csv | 14 columns |
| Madrid2012.csv | 14 columns |
| Madrid2013.csv | 14 columns |
| Madrid2014.csv | 14 columns |
| Madrid2015.csv | 14 columns |
| Madrid2016.csv | 14 columns |
| Madrid2017.csv | 16 columns |
| Madrid2018.csv | 16 columns |

### Data wrangling
Before getting to work with the previously described data, some steps were performed in order to make the data more manageable:

#### Selected Features

In order to perform both the exploratory data analysis and the prediction methods, we will focus on the five gases that harm humans the most when they are present, and that relate the most to pollution:

1. CO

2. O3

3. SO2

4. PMH10

5. NO2

#### Datasets unification

In order to work with the data, all the yearly datasets were unified in a single one, adding one additional feature to the existing date column that all of the datasets present: the year. Thus, after this transformation, a single dataset contained all the information about Madrid's air pollution in the last 17 years, instead of 17 different datasets (one per year). Two additional columns were added: the _only_month_  and  _only_year_ columns, wihic stand for the month and the year in which the observation was recorded, respectively.

#### Missing values treatment

As we can observe in the plot below, there is a high amount of missing values in the variables that we concern about:

```{r, creation of final dataframe with Na values, echo=FALSE,message=FALSE,warning=FALSE, include=FALSE}
library(ggplot2)
library(dplyr)
library(moments)
library(gridExtra)
library(tseries)
library(ppcor)
library(corrgram)
library(car)
library(corrplot)
library(mvoutlier)
library(ppcor)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(data.table)
library(GGally)
library(ggpubr)
library(naniar)
library(mice) #treatment of missing values
library(missForest) #for prodNA
library(reshape2)
# Load CSVs
madrid_2010 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2010.csv")
madrid_2011 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2011.csv")
madrid_2012 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2012.csv")
madrid_2013 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2013.csv")
madrid_2014 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2014.csv")
madrid_2015 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2015.csv")
madrid_2016 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2016.csv")
madrid_2017 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2017.csv")
madrid_2018 <-read_csv("data/Madrid_pollution_level_dataset/csvs_per_year/madrid_2018.csv")

station <- read.csv("data/Madrid_pollution_level_dataset/stations.csv")

# Group CSVs
madrid_list <- list(madrid_2010, madrid_2011, madrid_2012, madrid_2013,
                    madrid_2014, madrid_2015, madrid_2016, madrid_2017, madrid_2018)
madrid_18 <- as.data.frame(rbindlist(madrid_list, fill = T))

remove(madrid_2010)
remove(madrid_2011)
remove(madrid_2012)
remove(madrid_2013)
remove(madrid_2014)
remove(madrid_2015)
remove(madrid_2016)
remove(madrid_2017)
remove(madrid_2018)
remove(madrid_list)
# remove(madrid_18)

# Data Wrangling
madrid_final <- madrid_18[with(madrid_18, order(date)),]
madrid_final$only_month <-lapply(madrid_final$date, month)
madrid_final$only_year <-lapply(madrid_final$date, year)
madrid_final$date<-as.POSIXct(madrid_final$date,format = "%Y-%m-%d %H:%M:%S", tz='CET')
```

```{r, creation of final dataframe part 2, echo=FALSE,message=FALSE,warning=FALSE, include=FALSE}
library(dplyr)
selected_features <- dplyr::select(madrid_final, "date", "only_year", "only_month","station", "CO", "O_3", "PM10", "NO_2", "SO_2")
madrid_final1 <- as.data.frame(lapply(selected_features, unlist))
madrid_final1$only_year <- as.factor(madrid_final1$only_year)
madrid_final1$only_month <- as.factor(madrid_final1$only_month)
madrid_final1$station <- as.factor(madrid_final1$station)
```

```{r plot missing values for selected variables, fig.width=8, fig.height=6, echo=FALSE}
library(naniar)
library(dplyr)
gg_miss_var(dplyr::select(madrid_final1, 4:8), show_pct = T)
```

Thus, in order to deal with missing values, the mean of each one of the variables for each year, month and station is computed, so that all the missing values for each one of the columns in that same year, month and station are imputed with the corresponding mean.

### Descriptive statistics analysis

After the data wrangling step, we are ready to perform the exploratory data analysis.

To start the analysis, the distribution of the variables in our dataset in terms of center, dispersion and distribution descriptive measures, is analysed below.

After that, the linear relationships of the five variables are analysed, to determine the relations among them, if any.

```{r, creation of final dataframe without Na values, echo=FALSE,message=FALSE,warning=FALSE, include=FALSE}
library(ggplot2)
library(dplyr)
library(moments)
library(gridExtra)
library(tseries)
library(ppcor)
library(corrgram)
library(car)
library(corrplot)
library(mvoutlier)
library(ppcor)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(data.table)
library(GGally)
library(ggpubr)
library(naniar)
library(mice) #treatment of missing values
library(missForest) #for prodNA
library(reshape2)
# Load CSVs
madrid_2010 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2010.csv")
madrid_2011 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2011.csv")
madrid_2012 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2012.csv")
madrid_2013 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2013.csv")
madrid_2014 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2014.csv")
madrid_2015 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2015.csv")
madrid_2016 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2016.csv")
madrid_2017 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2017.csv")
madrid_2018 <-read_csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/dataWoNa/madrid_2018.csv")

station <- read.csv("/home/laura/MUII/Primero/data_processes/project/dataProcessesProject/data/Madrid_pollution_level_dataset/stations.csv")

# Group CSVs
madrid_list <- list(madrid_2010, madrid_2011, madrid_2012, madrid_2013,
                    madrid_2014, madrid_2015, madrid_2016, madrid_2017, madrid_2018)
madrid_18 <- as.data.frame(rbindlist(madrid_list, fill = T))

madrid_18$only_day <-unlist(lapply(madrid_18$date, day))

remove(madrid_2010)
remove(madrid_2011)
remove(madrid_2012)
remove(madrid_2013)
remove(madrid_2014)
remove(madrid_2015)
remove(madrid_2016)
remove(madrid_2017)
remove(madrid_2018)
remove(madrid_list)
# remove(madrid_18)

# Data Wrangling
madrid_final <- madrid_18[with(madrid_18, order(date)),]
madrid_final$only_month <-lapply(madrid_final$date, month)
madrid_final$only_year <-lapply(madrid_final$date, year)
madrid_final$date<-as.POSIXct(madrid_final$date,format = "%Y-%m-%d %H:%M:%S", tz='CET')

selected_features <- madrid_final %>%  
  dplyr::select("date", "only_year", "only_month","station", "CO", "O_3", "PM10", "NO_2", "SO_2")

madrid_final_exp <- as.data.frame(lapply(selected_features, unlist))
madrid_final_exp$only_year <- as.factor(madrid_final_exp$only_year)
madrid_final_exp$only_month <- as.factor(madrid_final_exp$only_month)
madrid_final_exp$station <- as.factor(madrid_final_exp$station)
```

#### Center, dispersion and distribution measures

The plot below is useful to visualize the center measures of the five selected variables:

```{r boxplots , fig.width=8, fig.height=4, echo=FALSE, warning=FALSE}
library(reshape2)
library(gridExtra)
library(ggplot2)
#EXPLORATORY DATA ANALYSIS

# 1. Center and distribution measures (boxplots and histograms)
melt_madrid_final_1 <- melt(madrid_final_exp,id.vars='station', measure.vars=c('O_3','PM10','NO_2','SO_2', 'CO'))
box_plot <- ggplot(melt_madrid_final_1,aes(x=variable, y=value, color=variable)) +
  geom_boxplot()+ coord_flip()+
  scale_colour_manual(values=c("magenta3","goldenrod3","brown","lightslateblue", "green"))+
  theme(legend.position="none")+scale_y_continuous(breaks = seq(0, 700, by = 50))+
  labs(title="Distribution of pollutants",x='Pollutants',y='ug/m3')
box_plot
```

As we can see, variables NO2, O3 and PMH10 spread along wide ranges, while variables SO2 and CO spread along narrower ranges. A characteristic that they all share is that all of them have many outliers or highly unexpected values.

The histograms below show a better insight of the shape of the distribution of the variables: as we can see, all of them are highly skewed to the right, so they don't follow a normal distribution.

```{r histograms , fig.width=8, fig.height=4, echo=FALSE, warning=FALSE}
library(reshape2)
library(gridExtra)
library(ggplot2)
histograms <-ggplot(melt_madrid_final_1,aes(x = value,fill=variable)) + 
  facet_wrap(~variable, nrow = 1) + 
  geom_histogram(binwidth=20)+
  scale_fill_manual(values=c("magenta3","goldenrod3","brown","lightslateblue", "green"))+
  theme(legend.position="none")+
  labs(x='ug/m3',y='Pollutants')
histograms
```

In the plot above, we can also observe a phenomenon that leads us to the conclussion that, depending on what we want to do with the data in upcoming sections, it may be a good approach to normalize it: variables SO2 and CO always take values that are very close to 0, while the other variables can reach much higher values.

#### Linear relationships analysis

As our intention is to make predictions using our data, it is convenient to analyse the linear relationships among the features, if any. In order to do so, the correlation matrix is represented in the plot below:

```{r correlation matrix , fig.width=8, fig.height=3, echo=FALSE, warning=FALSE}
library(ppcor)
library(corrplot)
library(dplyr)
madrid_final_exp_features = dplyr::select(madrid_final_exp, 5:9)
r <- cor(madrid_final_exp_features)

corrplot.mixed(r, lower="number", upper="ellipse")
```

In the plot, we can observe that the most correlated pair of variables is CO and NO_2, which are positively related with a value of 0.57. They are followed by O3 and NO2, which are negatively correlated with a value of -0.53. 

In order to have an overall insight on whether there are high correlations among the five variables or not, we are going to calculate the determinant of the correlation matrix:

```{r correlation matrix determinant, echo=TRUE, warning=FALSE, include = TRUE}
library(ppcor)
library(corrplot)
library(dplyr)
det(r)
```

The value obtained is close to 0, but not small enough to conclude the existence of variables that are linearly dependent on others. There are correlations among the variables, but they are not high enough.

This result is coherent, as the variables recorded in our data seem to be the outcome of some other predictors which are not included in our dataset. For instance, a high number of manufacturing plants in the city, or high traffic levels, could be a direct cause of a high level of some of the gases that our five variables stand for, like SO2.

Due to these findings, in upcoming steps of this project we will not be trying to predict any of the five variables as an outcome of the others.

### Data insights

It is interesting to answer some questions related to our data, in order to acquire some previous knowledge on how pollution behaves in Madrid's air, taking into account factors like year month and hour in the day, before procceeding to further steps in the project.

It is important to highlight that the questions that we intend to answer in this section are merely exploratory. We are still not trying to predict any phenomenon, but it may be interesting to find out some patterns in the temporal evolution of the five pollutants.

At first, it is interesting for us to observe the *yearly evolution of the maximum value that each pollutant reaches each month*. In order to do so, first the maximum value for each day on each month and year is computed. Then, the average value for each month per year is obtained. Note that the values have been normalized to be on the same scale. The resulting plot, for each pollutant, shows the following information:

```{r series1 , fig.width=8, fig.height=8, echo=FALSE, warning=FALSE}
library(dplyr)
library(gridExtra)
library(ggplot2)
plot_scale_monthly <- function(pol,title,colour) {
  pol <- enquo(pol)
  
  daily_max<-madrid_final_exp%>%
    mutate(date_ymd=as.Date(date,format="%Y-%m-%d"))%>%
    group_by(date_ymd)%>%
    summarise(max_emission=max(!!pol,na.rm=TRUE))
  month_avg<-daily_max%>%
    mutate(y_m_d=paste(substr(date_ymd,1,nchar(date_ymd)+2),"-01"))%>%
    group_by(y_m_d)%>%
    summarise(avg_emission=mean(max_emission,na.rm=TRUE))
  
  ggplot(data=month_avg,aes(x=as.Date(y_m_d,format="%Y - %m - %d"),y=scale(avg_emission)))+ geom_line(color=colour)+
    scale_x_date(breaks = seq(as.Date("2001-01-01"), as.Date("2018-01-01"), by="12 months"), date_labels = "%Y")+
    xlab('')+ylab(title)+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position="none")   
}

p1<-plot_scale_monthly(O_3,"O_3","magenta3")
p2<-plot_scale_monthly(PM10,"PM10","goldenrod3")
p3<-plot_scale_monthly(NO_2,"NO_2","brown")
p4<-plot_scale_monthly(SO_2,"SO_2","lightslateblue")
p5 <- plot_scale_monthly(CO,"CO","green")
grid.arrange(p1,p2,p3,p4,p5,nrow=5,top = "Yearly Evolution of the Maximum Value of Pollutants each Month")
```

The plot above shows some curious information:

* the clear patterns followed by *O3* and *SO2* are the opposite: while the levels of O3 reach their yearly maximum during the months in the middle of the year (summer months) and decrease towards the end of the year, we observe the opposite trend for SO2, that reaches its yearly minimum values towards the middle of the year, and its maximum towards the end.

* *PM10* levels have reached a more regular trend since year 2014. The trend of this variable is very irregular. This also happens with variable *NO2*, which has an irregular trend aswell, but this variable seems to reach the yearly maximum value towards the end of the year, even though the maximum value can change a lot from one year to another.

* The temporal evolution of variable *CO* is more irregular than the one for SO2 and O3, but a pattern is also appreciated: the yearly maximum value is reached mostly towards the end of the current year and the beginning of the next one, in the coolest months.

## Strength of relationships


## Prediction


## Results


## Discussion and future work